---
const { href, title, subtitle, image } = Astro.props;

const base = import.meta.env.BASE_URL || "/";

// nimmt alles, gibt immer einen String zurück (oder "")
const asString = (v: unknown) => (typeof v === "string" ? v : "");

// absolute URLs nicht anfassen, base nicht doppeln, und niemals new URL() mit Schrott
const toBasePath = (raw: unknown) => {
  const p = asString(raw).trim();
  if (!p) return "";

  // absolute URL (http, https) oder protocol-relative (//)
  if (/^(https?:)?\/\//.test(p)) return p;

  // wenn schon base-Prefix hat: so lassen
  if (p.startsWith(base)) return p;

  // normalisieren: kein führender Slash für new URL
  const cleaned = p.replace(/^\//, "");
  try {
    return new URL(cleaned, base).pathname;
  } catch {
    // Fallback ohne Crash
    return base.replace(/\/$/, "") + "/" + cleaned;
  }
};

const imgSrcRaw = toBasePath(image);
const linkHref = toBasePath(href);

// encodeURI: wichtig wegen Leerzeichen im Dateinamen
const imgSrc = imgSrcRaw ? encodeURI(imgSrcRaw) : "";

const isPlaceholder = imgSrc.includes("images/dunkel.png");
---

<a href={linkHref} class="filmstrip">
  <div class="filmstrip-inner">
    <img
  src={imgSrc || encodeURI(toBasePath("/images/dunkel.png"))}
  alt={title}
  class={isPlaceholder ? "placeholder-img" : "filmstrip-img"}
/>
  </div>

  <div class="filmstrip-title font-crimson">
    {title}
  </div>

  {subtitle && (
    <div class="filmstrip-subtitle">
      {subtitle}
    </div>
  )}
</a>

<style>
:global(.filmstrip) {
  position: relative;
  background: #460000;
  border-radius: 12px;
  padding: 24px 16px;
  overflow: hidden;
  box-shadow: 0 10px 30px rgba(0,0,0,.35);
  transition: transform .2s ease;

}

:global(.filmstrip:hover) {
  transform: translateY(-4px);
}

:global(.filmstrip)::before,
:global(.filmstrip)::after {
  content: "";
  position: absolute;
  left: 8px;
  right: 8px;
  height: 10px;
  background-image: repeating-linear-gradient(
    to right,
    #f9f1e2 0 8px,
    transparent 8px 16px
  );
  opacity: 0.85;
}

:global(.filmstrip)::before {
  top: 6px;
}

:global(.filmstrip)::after {
  bottom: 6px;
}

:global(.filmstrip-inner) {
  background: #f9f1e2;
  border-radius: 6px;
  height: 180px;
  display: flex;
  align-items: center;
  justify-content: center;
  overflow: hidden;
}

/* Normales Bild */
:global(.filmstrip-img) {
  max-width: 100%;
  max-height: 100%;
  object-fit: contain;
}

:global(.placeholder-img) {
  max-width: 8rem;
  max-height: 8rem;
  object-fit: contain;
  opacity: 0.4;
}

:global(.filmstrip-title) {
  margin-top: 12px;
  text-align: center;
  font-weight: 600;
  color: #f9f1e2;
  letter-spacing: 0.04em;
}

:global(.filmstrip-subtitle) {
  margin-top: 3px;
  margin-bottom: 2px;
  text-align: center;
  font-style: italic;
  font-weight: 400;
  color: #f9f1e2;
  font-size: 0.75rem; 
  letter-spacing: 0.02em;
}
</style>
