---
import type { CollectionEntry } from "astro:content";
import { getCollection } from "astro:content";

const base = import.meta.env.BASE_URL; // lokal: "/" | GH Pages: "/CineMap-Trier/"

// Prefixe absolute interne Pfade mit BASE_URL
const withBase = (p: string) =>
  p.startsWith("/") ? base.replace(/\/$/, "") + p : p;

// Slug aus entry.id ableiten (z.B. "foo/bar.md" -> "bar")
const slugFromId = (e: { id: string }) => {
  const s = e.id.replace(/\\/g, "/");
  const last = s.split("/").pop() ?? s;
  return last.replace(/\.[^.]+$/, "");
};

const kinos: CollectionEntry<"kino">[] = (await getCollection("kino")).sort(
  (a: CollectionEntry<"kino">, b: CollectionEntry<"kino">) =>
    a.data.name.localeCompare(b.data.name, "de")
);

const kinobetreiber: CollectionEntry<"kinobetreiber">[] = (
  await getCollection("kinobetreiber")
).sort(
  (a: CollectionEntry<"kinobetreiber">, b: CollectionEntry<"kinobetreiber">) =>
    a.data.name.localeCompare(b.data.name, "de")
);
---

<nav class="bg-[#460000] shadow antialiased md:static sticky top-0 z-50">
  <div class="max-w-7xl mx-auto flex items-center min-h-20 pl-0 pr-4 px-4">
    <!-- LOGO -->
    <a href={withBase("/")} class="shrink-0 mr-16">
      <img
        src={withBase("/images/hell.png")}
        alt="CineMap Logo"
        class="h-28 py-2 w-auto"
      />
    </a>

    <button
      id="mobile-menu-button"
      class="md:hidden text-white ml-auto p-2 focus:outline-none"
      aria-label="Menü öffnen"
    >
      <span id="burger-icon" class="block text-3xl leading-none">☰</span>
    </button>

    <ul
      class="hidden md:flex gap-2 text-white ml-auto"
      style='font-family: "Crimson Text", serif;'
    >
      <li><a href={withBase("/")} class="nav-link">Home</a></li>
      <li><a href={withBase("/geschichte")} class="nav-link">Geschichte</a></li>

      <li class="relative group">
        <a href={withBase("/kino")} class="nav-link flex items-center gap-1">
          Kinos <span class="dropdown-arrow">▾</span>
        </a>

        <ul class="dropdown">
          {kinos.map((kino: CollectionEntry<"kino">) => (
            <li>
              <a href={withBase(`/kino/${slugFromId(kino)}`)}>{kino.data.name}</a>
            </li>
          ))}
        </ul>
      </li>

      <li class="relative group">
        <a href={withBase("/kinobetreiber")} class="nav-link flex items-center gap-1">
          Betreiber <span class="dropdown-arrow">▾</span>
        </a>

        <ul class="dropdown">
          {kinobetreiber.map((b: CollectionEntry<"kinobetreiber">) => (
            <li>
              <a href={withBase(`/kinobetreiber/${slugFromId(b)}`)}>{b.data.name}</a>
            </li>
          ))}
        </ul>
      </li>

      <li class="relative group">
        <span class="nav-link flex items-center gap-1 cursor-default">
          Karte <span class="dropdown-arrow">▾</span>
        </span>

        <ul class="dropdown">
          <li><a href={withBase("/karte")}>Karte</a></li>
          <li><a href={withBase("/zeitleiste")}>Zeitleiste</a></li>
        </ul>
      </li>

      <li class="relative group">
        <span class="nav-link flex items-center gap-1 cursor-default">
          Über Uns <span class="dropdown-arrow">▾</span>
        </span>

        <ul class="dropdown">
          <li><a href={withBase("/projekt")}>Projekt</a></li>
          <li><a href={withBase("/methoden")}>Methoden</a></li>
          <li><a href={withBase("/team")}>Team</a></li>
        </ul>
      </li>
    </ul>
  </div>
</nav>

<div
  id="mobile-menu"
  class="md:hidden hidden bg-[#460000] text-white px-4 pb-6"
  style='font-family: "Crimson Text", serif;'
>
  <ul class="space-y-2">
    <li><a href={withBase("/")} class="block py-2">Home</a></li>
    <li><a href={withBase("/geschichte")} class="block py-2">Geschichte</a></li>

    <li class="pt-2 font-semibold">Kinos</li>
    {kinos.map((kino: CollectionEntry<"kino">) => (
      <li class="pl-4">
        <a href={withBase(`/kino/${slugFromId(kino)}`)} class="block py-1">
          {kino.data.name}
        </a>
      </li>
    ))}

    <li class="pt-2 font-semibold">Betreiber</li>
    {kinobetreiber.map((b: CollectionEntry<"kinobetreiber">) => (
      <li class="pl-4">
        <a href={withBase(`/kinobetreiber/${slugFromId(b)}`)} class="block py-1">
          {b.data.name}
        </a>
      </li>
    ))}

    <li class="pt-2 font-semibold">Karte</li>
    <li class="pl-4"><a href={withBase("/karte")}>Karte</a></li>
    <li class="pl-4"><a href={withBase("/zeitleiste")}>Zeitleiste</a></li>

    <li class="pt-2 font-semibold">Über Uns</li>
    <li class="pl-4"><a href={withBase("/projekt")}>Projekt</a></li>
    <li class="pl-4"><a href={withBase("/methoden")}>Methoden</a></li>
    <li class="pl-4"><a href={withBase("/team")}>Team</a></li>
  </ul>
</div>

<style>
.nav-link {
  padding: 1rem 1.25rem;
  display: inline-block;
}

.nav-link:hover {
  background: rgba(255,255,255,0.1);
  border-radius: 0.5rem;
}

.dropdown-arrow {
  font-size: 0.75rem;
  opacity: 0.8;
}

/* DROPDOWN */
.dropdown {
  position: absolute;
  top: 100%;
  left: 0;
  min-width: 220px;
  max-height: 68vh;
  overflow-y: auto;
  background: white;
  color: #460000;
  border-radius: 0.75rem;
  box-shadow: 0 12px 30px rgba(0,0,0,0.15);
  padding: 0.5rem 0;
  opacity: 0;
  transform: translateY(8px);
  pointer-events: none;
  transition: all 0.2s ease;
  z-index: 50;
}

.group:hover .dropdown {
  opacity: 1;
  transform: translateY(0);
  pointer-events: auto;
}

.dropdown li a {
  display: block;
  padding: 0.5rem 1rem;
  white-space: nowrap;
}

.dropdown li a:hover {
  background: #f5efe6;
}
</style>

<script>
  const btn = document.getElementById("mobile-menu-button");
  const menu = document.getElementById("mobile-menu");
  const icon = document.getElementById("burger-icon");

  if (btn && menu && icon) {
    btn.addEventListener("click", () => {
      menu.classList.toggle("hidden");
      icon.textContent = menu.classList.contains("hidden") ? "☰" : "✕";
    });

    menu.querySelectorAll("a").forEach((link) => {
      link.addEventListener("click", () => {
        menu.classList.add("hidden");
        icon.textContent = "☰";
      });
    });
  }
</script>
